(function(d){var b=function(l,j,m){var k=document.createElement(l);if(j){k.id=j}if(m){k.className=m}return k},i=function(j,k){j.appendChild(k)},e,h,g;function f(j){j.end({left:h,top:e})}function a(m){var p=b("DIV","handcrop_modal","modal fade large"),n=b("DIV","handcrop_modal_dialog","modal-dialog modal-lg"),o=b("DIV",null,"modal-content"),l=b("DIV","handcrop_modal_body","modal-body"),j=b("DIV",null,"modal-footer"),q=b("BUTTON","handcrop_modal_submit","btn btn-primary");q.setAttribute("data-dismiss","modal");p.setAttribute("data-backdrop","static");q.innerHTML="Crop";i(document.body,p);i(p,n);i(n,o);i(o,l);i(o,j);i(j,q);if(true===m.debug){var k=b("DIV","modal_debug");i(j,k)}d("#handcrop_modal_submit").bind("mouseup",function(){f(m)});return l}function c(n,m){d(g).empty();var o=b("DIV","handcrop_crop"),k=b("DIV","handcrop_container"),l=new Image(),j;i(g,o);i(o,k);i(k,l);d(o).css({width:(m.width+2)+"px",height:(m.height+2)+"px"});d(l).attr("src",n);if(Math.abs(d(l).width()-d(o).width())>Math.abs(d(l).height()-d(o).height())){d(l).css("width",m.width+"px")}else{d(l).css("height",m.height+"px")}j=function(p){if(0===d(l).height()||0===d(l).width()){return setTimeout(function(){j(p)},20)}p()};j(function(){var s=d(l).height(),q=d(l).width(),r=Math.abs(s-d(o).height()),p=Math.abs(q-d(o).width());d(k).css({width:(q+p)+"px",height:(s+r)+"px",top:-(r)+"px",left:-(p)+"px"});d(l).css({top:(r/2)+"px",left:(p/2)+"px"});e=r-parseInt(d(l).css("top").substr(0,(d(l).css("top")).length-2),10);h=p-parseInt(d(l).css("left").substr(0,(d(l).css("left")).length-2),10);m.dragOptions.containment="parent";m.dragOptions.drag=function(u,v){var t=d("#handcrop_crop img");e=r-parseInt(t.css("top").substr(0,(t.css("top")).length-2),10);h=p-parseInt(t.css("left").substr(0,(t.css("left")).length-2),10);if(true===m.debug){d("#modal_debug").html("x: "+h+", y: "+e)}};d("#handcrop_crop img").disableSelection().draggable(m.dragOptions);d("#handcrop_modal_dialog").css("width",(d(o).width()+50)+"px")})}d.fn.handcrop=function(j){this.each(function(){var k={width:320,height:200,debug:false,dragOptions:{},end:function(){}};d.extend(k,j);d(this).bind("mouseup",function(){if(0===d("#handcrop_modal").length){g=a(k)}c(d(this).attr("src"),k);d("#handcrop_modal").modal()})});return this}})(jQuery);